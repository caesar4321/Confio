P2P Trade Smart Contract (Algorand)

Overview
- Escrow-based peer-to-peer trading for cUSD and CONFIO with dispute resolution and a 15-minute window (900 seconds).
- Uses box storage for a fixed-size trade record; optional compact dispute record with hashed reason.
- Supports an optional sponsor address to fund box MBR so users don’t need spare ALGO.

Key Features
- Escrow protection until completion or cancellation
- 15-minute trade window; cancels expired active trades
- Self-trading prevention on accept
- Admin dispute resolution with compact, hashed-reason storage
- Multi-token (cUSD and CONFIO); no personal data on-chain

Security Highlights
- Binds the seller AXFER to the AppCall on create to prevent regrouping
- Checks recipient opt-in before any ASA transfer (buyer/seller/winner)
- Inner transactions set `fee: 0`; callers should cover outer fees or include a fee-bump Payment
- Fixed-size boxes with dynamic MBR enforcement; `trade_id` length bounded to control MBR

Transaction Groups
- Create trade: [Payment(sponsor|seller→app, amount=MBR), AXFER(seller→app), AppCall(create_trade)]
  - MBR = 2500 + 400*(key_len + value_len); trade value_len = 113 bytes.
- Accept: [AppCall(accept_trade)]
- Confirm received (seller): [AppCall(confirm_payment_received)] (+ optional fee-bump)
- Cancel: [AppCall(cancel_trade)] (+ optional fee-bump)
- Dispute: [Payment(sponsor|opener→app, amount=MBR), AppCall(open_dispute)] (value_len = 72)
- Resolve (admin): [AppCall(resolve_dispute)] (+ optional fee-bump)

Trade States
- PENDING (0): Trade created, waiting for buyer
- ACTIVE (1): Buyer accepted, waiting for payment
- COMPLETED (2): Payment confirmed, funds released
- CANCELLED (3): Trade cancelled, funds returned
- DISPUTED (4): Under dispute resolution
- EXPIRED (5): Time window exceeded (used in logic for cancellation)

Integration
- Trade IDs are generated by the backend (e.g., UUIDs).
- Fiat currency code and PII are stored off-chain; only hashes/minimal data on-chain.
- Backend verifies fiat payment and triggers `confirm_payment_received`.

Statistics and Admin
- Stats: total trades created/completed/cancelled/disputed; cUSD and CONFIO volumes.
- Admin methods: `pause()`, `unpause()`, `resolve_dispute()`, `set_sponsor(address)`.

Storage Layout
- Trade box key: `trade_id` (<= 64 bytes).
- Trade value (113 bytes): seller(32) | amount(8) | asset_id(8) | fiat_amount(8) | created_at(8) | expires_at(8) | status(1) | accepted_at(8) | buyer(32)
- Dispute box key: `trade_id + "_dispute"`.
- Dispute value (72 bytes): opened_by(32) | opened_at(8) | reason_hash(32).

Build/Artifacts
- This repository uses PyTeal/Beaker for Algorand. Running the module emits TEAL and JSON artifacts alongside the contract source.

Future Enhancements
- Reputation system for traders
- Partial trade fulfillment
- Multi-signature dispute resolution
- Fee distribution to CONFIO holders
- Trade history queries
