# P2P Trade Smart Contract

A secure escrow-based peer-to-peer trading system for cryptocurrency-to-fiat exchanges on the Sui blockchain.

## Overview

The P2P Trade contract enables users to safely exchange cryptocurrencies (cUSD and CONFIO) for fiat currencies through an escrow mechanism. The contract ensures that crypto funds are locked until the fiat payment is confirmed, protecting both buyers and sellers.

## Key Features

- **Escrow Protection**: Cryptocurrency funds are locked in the smart contract until trade completion
- **15-Minute Trade Window**: Trades automatically expire after 900 seconds if not completed
- **Self-Trading Prevention**: Built-in protection against users trading with themselves
- **Dispute Resolution**: Admin-mediated dispute resolution for contested trades
- **Multi-Token Support**: Supports both cUSD stablecoin and CONFIO governance token
- **Privacy-Preserving**: No personal information stored on-chain
- **Atomic Operations**: All fund transfers are atomic and secure

## Security Features

### Completed Security Tests

1. **Self-Trading Prevention** ✅
   - Test: Seller attempts to accept their own trade
   - Result: Transaction aborts with `ESelfTrade` error code 13
   - Protection: Prevents wash trading and market manipulation

2. **Unauthorized Payment Confirmation** ✅
   - Test: Buyer attempts to confirm payment themselves to steal funds
   - Result: Transaction aborts with `ENotAuthorized` error code 1
   - Protection: Only sellers can confirm fiat payment receipt

### Escrow Vault Security

The contract uses separate escrow vaults for each token type:
- `cusd_balances`: Table mapping trade IDs to locked cUSD balances
- `confio_balances`: Table mapping trade IDs to locked CONFIO balances

Funds can only be released through:
1. Seller confirming payment received
2. Trade cancellation (returns to seller)
3. Admin dispute resolution

## Trade Flow

### 1. Create Trade (Seller)
```move
create_cusd_trade(
    registry: &mut TradeRegistry,
    vault: &mut EscrowVault,
    clock: &Clock,
    payment: Coin<CUSD>,
    trade_id: vector<u8>,    // Generated by Django
    fiat_amount: u64,
    fiat_currency: vector<u8>,
    ctx: &mut TxContext
)
```

### 2. Accept Trade (Buyer)
```move
accept_trade(
    registry: &mut TradeRegistry,
    clock: &Clock,
    trade_id: vector<u8>,
    ctx: &mut TxContext
)
```

### 3. Confirm Payment (Seller)
```move
confirm_payment_received(
    registry: &mut TradeRegistry,
    vault: &mut EscrowVault,
    clock: &Clock,
    trade_id: vector<u8>,
    ctx: &mut TxContext
)
```

## Trade States

- `STATUS_PENDING (0)`: Trade created, waiting for buyer
- `STATUS_ACTIVE (1)`: Buyer accepted, waiting for payment
- `STATUS_COMPLETED (2)`: Payment confirmed, funds released
- `STATUS_CANCELLED (3)`: Trade cancelled, funds returned
- `STATUS_DISPUTED (4)`: Under dispute resolution
- `STATUS_EXPIRED (5)`: Time window exceeded

## Error Codes

- `ENotAuthorized (1)`: Unauthorized action attempt
- `EInvalidAmount (2)`: Invalid trade amount
- `ETradeNotFound (3)`: Trade ID doesn't exist
- `ETradeExpired (5)`: Trade time window exceeded
- `EInvalidTradeState (11)`: Invalid state transition
- `ESystemPaused (12)`: System temporarily paused
- `ESelfTrade (13)`: Self-trading attempt

## Integration with Django Backend

The contract is designed to work with the Confío Django backend:
- Trade IDs are generated by Django (UUIDs)
- Personal information (phone numbers, payment methods) stored off-chain
- Django handles fiat payment verification
- Smart contract handles crypto escrow and release

## Statistics Tracking

The contract tracks:
- Total trades created
- Total trades completed
- Total trades cancelled
- Total trades disputed
- Total cUSD volume traded
- Total CONFIO volume traded

## Admin Functions

- `pause()`: Temporarily pause all trading
- `unpause()`: Resume trading
- `resolve_dispute()`: Resolve disputed trades

## Building and Testing

```bash
# Build the contract
sui move build

# Run tests
sui move test

# Deploy (testnet)
sui client publish --gas-budget 100000000
```

## Future Enhancements

- [ ] Reputation system for traders
- [ ] Partial trade fulfillment
- [ ] Multi-signature dispute resolution
- [ ] Fee distribution to CONFIO holders
- [ ] Trade history queries